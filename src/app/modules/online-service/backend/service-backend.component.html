<div class="container-fluid">
    <app-page-tip>
        <ul>
            <li>客服接待界面</li>
        </ul>
    </app-page-tip>
    <div class="panel-container">
        <div class="row">
            <div class="col-md-3">
                <div class="search-bar">
                    <input type="text" class="form-control" placeholder="搜索" [field]="dataForm.keywords">
                </div>
                <div class="expand-box open" [class]="{open: expandIndex < 1}">
                    <div class="expand-header" (click)="expandIndex = 0">会话中（{{ sessionItems1().length }}）</div>
                    <div class="expand-body">
                        @for (item of sessionItems1(); track $index) {
                        <div class="user-item" (click)="tapSession(item)">
                            <div class="avatar">
                                <img [src]="item.user?.avatar" alt="">
                            </div>
                            <div class="name">{{ item.name }}</div>
                            <div class="time">{{ item.created_at | ago }}</div>
                            <div class="content">{{ item.content }}</div>
                            @if (item.count && item.count > 0) {
                            <div class="count">{{ item.count > 99 ? '+99' : item.count }}</div>
                            }
                        </div>
                        }
                    </div>
                </div>
                <div class="expand-box" [class]="{open: expandIndex == 1}">
                    <div class="expand-header" (click)="expandIndex = 1">排队中（{{ sessionItems2().length }}）</div>
                    <div class="expand-body">
                        @for (item of sessionItems2(); track $index) {
                        <div class="user-item" (click)="tapSession(item)">
                            <div class="avatar">
                                <img [src]="item.user?.avatar" alt="">
                            </div>
                            <div class="name">{{ item.name }}</div>
                            <div class="time">{{ item.created_at | ago }}</div>
                            <div class="content">{{ item.content }}</div>
                            @if (item.count && item.count > 0) {
                            <div class="count">{{ item.count > 99 ? '+99' : item.count }}</div>
                            }
                        </div>
                        }
                    </div>
                </div>
                <div class="expand-box" [class]="{open: expandIndex == 2}">
                    <div class="expand-header" (click)="expandIndex = 2">会话结束（{{ sessionItems3().length }}）</div>
                    <div class="expand-body">
                        @for (item of sessionItems3(); track $index) {
                        <div class="user-item" (click)="tapSession(item)">
                            <div class="avatar">
                                <img [src]="item.user?.avatar" alt="">
                            </div>
                            <div class="name">{{ item.name }}</div>
                            <div class="time">{{ item.created_at | ago }}</div>
                            <div class="content">{{ item.content }}</div>
                            @if (item.count && item.count > 0) {
                            <div class="count">{{ item.count > 99 ? '+99' : item.count }}</div>
                            }
                        </div>
                        }
                    </div>
                </div>
            </div>
            @if (session) {
            <div class="col-md-6">
                <div class="title-bar">
                    <div class="title">{{ session.name }}</div>
                    <select class="form-control" [field]="dataForm.service_word" (change)="onReplyChange()">
                        <option [value]="0">无自动回复</option>
                        @for (item of autoWords; track $index) {
                            <option [value]="item.id">{{ item.content }}</option>
                        }
                    </select>
                    <div class="btn btn-info" (click)="openTransfer(transferModal)">转接</div>
                    <div class="btn btn-primary" (click)="openRemark(remarkModal)">备注</div>
                    <div class="btn btn-danger" (click)="tapClose()">关闭</div>
                </div>
                <app-message-container class="message-body" [items]="messageItems" [currentId]="currentUser" />
                <div class="message-tools">
                    <app-emoji-picker class="tool-item" (tapped)="tapEmoji($event)">
                        <i class="iconfont icon-smile-o"></i>
                    </app-emoji-picker>
                    <label class="tool-item" for="upload-img">
                        <i class="iconfont icon-image"></i>
                        <input type="file" name="file" id="upload-img" (change)="uploadImage($event)" accept="image/*"/>
                    </label>
                    <label class="tool-item" for="upload-video">
                        <i class="iconfont icon-film"></i>
                        <input type="file" name="file" id="upload-video" (change)="uploadVideo($event)" accept="video/*"/>
                    </label>
                    <label class="tool-item" for="upload-file">
                        <i class="iconfont icon-file-o"></i>
                        <input type="file" name="file" id="upload-file" (change)="uploadFile($event)"/>
                    </label>
                </div>
                <div class="message-editor">
                    <textarea class="form-control message-text" [field]="dataForm.message" placeholder="请输入内容"></textarea>
                    <div class="message-action">
                        <button (click)="tapSend()">发送</button>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tab-box">
                    <div class="tab-header">
                        <div class="tab-item" [class]="{active: tabIndex < 1}" (click)="tabIndex = 0">用户信息</div>
                        <div class="tab-item" [class]="{active: tabIndex == 1}" (click)="tabIndex = 1">常用语</div>
                    </div>
                    <div class="tab-body">
                        <div class="tab-item" [class]="{active: tabIndex < 1}">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>参数</th>
                                        <th>值</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>IP</td>
                                        <td>{{ session.ip }}</td>
                                    </tr>
                                    @if (session.user_id > 0) {
                                    <tr>
                                        <td>会员名</td>
                                        <td>{{ session.user.name }}({{ session.user_id }})</td>
                                    </tr>
                                    }
                                    <tr>
                                        <td>备注</td>
                                        <td>{{ session.remark }}</td>
                                    </tr>
                                    <tr>
                                        <td>User Agent</td>
                                        <td>{{ session.user_agent }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-item" [class]="{active: tabIndex == 1}">
                            <ul class="tree-box">
                                @for (item of categories; track $index) {
                                <li class="tree-item">
                                    <div class="tree-name">{{ item.name }}</div>
                                    <ul class="tree-body">
                                        @for (it of item.words; track $index) {
                                        <li class="tree-item">
                                            <div class="tree-name" (click)="tapWord(it)">{{ it.content }}</div>
                                        </li>
                                        }
                                    </ul>
                                </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>

<app-dialog-box #remarkModal title="备注">
    <div class="form-group">
        <label for="name-input">备注内容</label>
        <div class="input-group-control">
            <textarea class="form-control" [field]="dataForm.remark"></textarea>
        </div>
    </div>
</app-dialog-box>

<app-dialog-box #transferModal title="转接其他客服">
    <input type="text" class="form-control" placeholder="请输入客服昵称" [field]="dataForm.user_keywords" (input)="onSearchUser()">
        @for (item of users; track $index) {
            <div class="line-item" [class]="{active: userSelected == item.user_id}" (click)="userSelected = item.user_id">
                【{{ item.category.name }}】{{ item.user.name }}(ID: {{ item.user_id }})
            </div>
        }
</app-dialog-box>
